---
layout: post
category : Simulation
tags : [QC, QUIP]
---
{% include JB/setup %}


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 前言</a></li>
<li><a href="#sec-2">2 准备工作</a>
<ul>
<li><a href="#sec-2-1">2.1 ifort, icc</a></li>
<li><a href="#sec-2-2">2.2 lapack</a></li>
<li><a href="#sec-2-3">2.3 FoX（可选）</a></li>
<li><a href="#sec-2-4">2.4 QUIP（可选）</a>
<ul>
<li><a href="#sec-2-4-1">2.4.1 下载代码</a></li>
<li><a href="#sec-2-4-2">2.4.2 代码修改</a>
<ul>
<li><a href="#sec-2-4-2-1">2.4.2.1 ./utility<sub>scripts</sub>/gapversion.sh</a></li>
<li><a href="#sec-2-4-2-2">2.4.2.2 ./QUIP<sub>core</sub>/QC<sub>QUIP</sub><sub>Wrapper</sub>.f95</a></li>
<li><a href="#sec-2-4-2-3">2.4.2.3 ./Makefile</a></li>
<li><a href="#sec-2-4-2-4">2.4.2.4 ./Makefile.rules</a></li>
<li><a href="#sec-2-4-2-5">2.4.2.5 Thirdparty库</a></li>
</ul>
</li>
<li><a href="#sec-2-4-3">2.4.3 编译</a>
<ul>
<li><a href="#sec-2-4-3-1">2.4.3.1 编译选项</a></li>
</ul></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-3">3 QC-QUIP编译</a>
<ul>
<li><a href="#sec-3-1">3.1 下载代码</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">前言</h2>
<div class="outline-text-2" id="text-1">

<p>历时近一星期终于大概弄清楚了如何编译QC-QUIP里的应用，由于代码是08年的，而且引用了不常见的库函数，加之代码本身的Makefile做得也很不完善，过程比较复杂辛苦。这里记录一下用32位Ubuntu12.04要如何操作。
</p></div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">准备工作</h2>
<div class="outline-text-2" id="text-2">

<p>基本的编译环境如build-essential, gfortran等的安装自然是需要的，这里且不详述。除此之外尚须安装以下库：
</p>
</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1">ifort, icc</h3>
<div class="outline-text-3" id="text-2-1">

<p>Intel编译器的安装似乎并不是必须的，而且还会引来一点麻烦。
但由于QC-QUIP的Makefile本身在使用gfortran编译时会有错误，建议还是使用QC-QUIP默认的ifort编译器进行编译。安装的方法很简单：
首先到<a href="http://software.intel.com/en-us/non-commercial-software-development">这里</a>
申请下载Intel® Fortran Composer XE 2013 for Linux和Intel® C++ Composer XE 2013 for Linux。
填写相应个人信息后会收到Intel的邮件，下载安装包解压。
执行Install.sh，使用默认配置并填入邮件中的序列好就会自动安装好了。
之后在/etc/environment中写入相应的路径即可，由于我是32位系统，按默认安装配置的话写入的是/opt/intel/composer<sub>xe</sub><sub>2013</sub>.5.192/bin/ia32和/opt/intel/composer<sub>xe</sub><sub>2013</sub>.5.192/mpirt/bin/ia32。
其中后者是并行编译时需要的，暂时可不用，2013.5.192为版本号，应替换为你自己的版本，ia32代表32位系统，如果是64位系统应该是intel64。
</p></div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2">lapack</h3>
<div class="outline-text-3" id="text-2-2">

<p>除了QC-QUIP以外，很多模拟方面的应用如lammps等都会使用lapack和blas库，blas集成在lapack当中，因此只需安装lapack。从<a href="http://www.netlib.org/lapack/">官方网站</a>
下载编译即可，由于默认的编译器是gfortran，而且lapack和blas在很多其他软件中也会使用到，因此使用更常用的gfortran编译会比较方便。
直接make之后lapack的跟文件夹下会出现liblapack.a和librefblas.a这两个库文件。注意很多软件默认的blas库是-lblas，因此在编译时应注意修改为-lrefblas。
</p></div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3">FoX（可选）</h3>
<div class="outline-text-3" id="text-2-3">

<p><a href="http://www1.gly.bris.ac.uk/~walker/FoX/">FoX</a> 是一个在Fortran语言和XML语言间翻译通信的库，现在的版本是4.1.2。由于QUIP自带有一个4.0.3版的，所以实际上可以不另行安装。
安装FoX的最新版本推荐使用git。之后的QUIP也需要用git安装，所以首先安装git：
</p>


<pre class="example">sudo apt-get git-core
</pre>

<p>
建立一个FoX文件夹后在该文件夹内执行：
</p>


<pre class="example">git init
git pull https://github.com/andreww/fox
</pre>

<p>
之后会从github下载代码到本地。编译最好用ifort编译，因此执行：
</p>


<pre class="example">./configure FC=/opt/intel/bin/ifort
make
</pre>

<p>
其中`FC=/opt/intel/bin/ifort`指定了编译器的路径。
编译好之后的库文件都在FoX/objs/lib中。
</p></div>

</div>

<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4">QUIP（可选）</h3>
<div class="outline-text-3" id="text-2-4">

<p>QC-QUIP的一个主要的改变就是对QUIP的支持。调用QUIP的目的可能是为了便于实现多晶的模拟。如果为了方便起见其实可以选择不装QUIP，等有需要的时候再重新编译。
</p>
</div>

<div id="outline-container-2-4-1" class="outline-4">
<h4 id="sec-2-4-1">下载代码</h4>
<div class="outline-text-4" id="text-2-4-1">

<p>QUIP实际上指的是<a href="http://www.libatoms.org/">libAtoms+QUIP</a>。
它的下载同样是首先建立一个QUIP文件夹，然后在该文件夹内执行：
</p>


<pre class="example">git init
git pull https://github.com/libAtoms/QUIP
</pre>

</div>

</div>

<div id="outline-container-2-4-2" class="outline-4">
<h4 id="sec-2-4-2">代码修改</h4>
<div class="outline-text-4" id="text-2-4-2">

<p>之后在编译之前有必要对代码进行一些修改否则会出错。
</p>
</div>

<div id="outline-container-2-4-2-1" class="outline-5">
<h5 id="sec-2-4-2-1">./utility<sub>scripts</sub>/gapversion.sh</h5>
<div class="outline-text-5" id="text-2-4-2-1">

<p>以下讨论均假定处于QUIP文件夹下，上述文件路径为相对于QUIP文件夹的相对路径。
由于<a href="https://wiki.ubuntu.com/DashAsBinSh">Ubuntu使用的shell是desh而不是bash</a>，
在这个脚本文件中的function命令shell会识别不出来因而报错。因此必须做以下改动：
</p>


<pre class="example">function git_date -&gt; git_date()
</pre>

</div>

</div>

<div id="outline-container-2-4-2-2" class="outline-5">
<h5 id="sec-2-4-2-2">./QUIP<sub>core</sub>/QC<sub>QUIP</sub><sub>Wrapper</sub>.f95</h5>
<div class="outline-text-5" id="text-2-4-2-2">

<p>接下来这个是非常明显的编译错误，在该文件中调用了没有在only list中声明过的程序，因此应做出如下修改：
</p>


<pre class="example">use system_module, only : dp, system_initialise, INPUT, system_abort,verbosity_push, verbosity_pop, PRINT_SILENT, operator(//), inoutput, PRINT_ALWAYS
-&gt;
use system_module, only : dp, system_initialise, INPUT, system_abort,verbosity_push, verbosity_pop, PRINT_SILENT, operator(//), inoutput, PRINT_ALWAYS, print

use table_module, only : table, wipe, int_part -&gt;
use table_module, only : table, wipe, int_part, append

use atoms_types_module, only : atoms, assign_pointer, add_property
-&gt;
use atoms_types_module, only : atoms, assign_pointer, add_property, add_property_from_pointer

use potential_module, only : potential, initialise, finalise, calc
-&gt;
use potential_module, only : potential, initialise, finalise, calc, print
</pre>

</div>

</div>

<div id="outline-container-2-4-2-3" class="outline-5">
<h5 id="sec-2-4-2-3">./Makefile</h5>
<div class="outline-text-5" id="text-2-4-2-3">

<p>在编译之前需要指定使用的编译器，这里的方法是通过设定QUIP<sub>ARCH这一环境变量的值指定</sub>./Makefiles里的相应文件。方便起见直接在QUIP根目录的Makefile文件内指定，在文件开头加入：
</p>


<pre class="example">QUIP_ARCH = linux_x86_64_ifort_icc_serial
</pre>

<p>
这相当于指定使用`./Makefiles/Makefile.linux<sub>x86</sub><sub>64</sub><sub>ifort</sub><sub>icc</sub><sub>serial`这一文件。我实际使用的是`QUIP</sub><sub>ARCH</sub> = linux<sub>x86</sub><sub>64</sub><sub>ifort</sub><sub>icc`，但事后发现`Makefile</sub>.linux<sub>x86</sub><sub>64</sub><sub>ifort</sub><sub>icc</sub><sub>serial`写得更加完善一些，因此建议使用上述设置。</sub>
</p></div>

</div>

<div id="outline-container-2-4-2-4" class="outline-5">
<h5 id="sec-2-4-2-4">./Makefile.rules</h5>
<div class="outline-text-5" id="text-2-4-2-4">

<p>由于QUIP我们选择用ifort编译，而lapack和blas则是用gfortran编译，因此在编译QUIP过程中使用lapack和blas库时会遇到问题：它们调用了一个gfortran特有的库函数。对此的解决办法是将gfortran库也编译进去，在文件中加入以下内容：
</p>


<pre class="example">GF_LIBDIR = /usr/lib/gcc/i686-linux-gnu/4.6
GF_LIB    = -lgfortran
</pre>

<p>
然后做如下修改：
</p>


<pre class="example">SYSLIBS += -L${FOX_LIBDIR} ${FOX_LIBS} -&gt;
SYSLIBS += -L${FOX_LIBDIR} ${FOX_LIBS} -L${GF_LIBDIR} ${GF_LIB}
</pre>

</div>

</div>

<div id="outline-container-2-4-2-5" class="outline-5">
<h5 id="sec-2-4-2-5">Thirdparty库</h5>
<div class="outline-text-5" id="text-2-4-2-5">

<p>最新的QUIP删去了所谓Thirdparty库的内容，但一些Makefile里却依然有-lthirdparty。
额外安装thirdparty库似乎需要`git pull git@gc121mac1.eng.cam.ac.uk:ThirdParty`，但是这里需要输入密码。
由于这个库不存在似乎已不影响实际使用，因此我们直接删掉所有的-lthirdparty即可：
</p><ul>
<li>./QUIP<sub>Core</sub>/Makefile
</li>
</ul>




<pre class="example">  LIBS = -L. -lquip_core ${GP_LIB} -latoms -lthirdparty -&gt;
  LIBS = -L. -lquip_core ${GP_LIB} -latoms
- ./QUIP_Programs/Makefile
  LIBS =  -L. -lquiputils -lquip_core ${GP_LIB} -latoms -lthirdparty -&gt;
  LIBS =  -L. -lquiputils -lquip_core ${GP_LIB} -latoms
</pre>

<ul>
<li>./QUIP<sub>FilePot</sub><sub>Drivers</sub>/Makefile
</li>
</ul>




<pre class="example">LIBS =  -L. -lquiputils -lquip_core ${GP_LIB} -latoms -lthirdparty -&gt;
LIBS =  -L. -lquiputils -lquip_core ${GP_LIB} -latoms
</pre>

<ul>
<li>./Tools/Makefile
</li>
</ul>




<pre class="example">LIBS =  -L. -lquiputils -lquip_core ${GP_LIB} -latoms -lthirdparty -&gt;
LIBS =  -L. -lquiputils -lquip_core ${GP_LIB} -latoms
</pre>

</div>
</div>

</div>

<div id="outline-container-2-4-3" class="outline-4">
<h4 id="sec-2-4-3">编译</h4>
<div class="outline-text-4" id="text-2-4-3">

<p>做好以上准备后进行编译即可。在QUIP根目录下执行：
</p>


<pre class="example">make all
</pre>


</div>

<div id="outline-container-2-4-3-1" class="outline-5">
<h5 id="sec-2-4-3-1">编译选项</h5>
<div class="outline-text-5" id="text-2-4-3-1">

<p>编译过程中会有很多选项需要设置，使用默认设置的话直接Enter即可。以下是一些需要指定的地方：
</p>


<pre class="example">Please enter the linking options for LAPACK and BLAS libraries:
   Default:
-L/home/lilin/usr/lapack-3.4.2 -llapack -lrefblas
Please enter directory where FoX libraries are kept:
   Default: use included version FoX-4.0.3
/home/lilin/usr/FoX-4.1.1/objs/lib
Please enter directory where FoX include files are kept:
/home/lilin/usr/FoX-4.1.1/objs/finclude
Do you want to compile with ONIOM support? [y/n]
   Default: n
y
Do you want to compile with TB support? [y/n]
   Default: n
y
Do you want to compile with QuasiContinuum wrapper support? [y/n]
   Default: n
y
</pre>

<p>
注意我的程序基本是放在自己的home文件夹/home/lilin中的usr下的，对目录的设置应根据自己的安装地址进行修改。有一个对于KIM的支持这里默认没有装，对于它的介绍可以看<a href="https://openkim.org/">这里</a>。
已知lammps也提供对KIM的支持，以后会介绍怎样在lammps的安装中支持该库。这里不在QUIP中包含KIM库的原因是我安装的KIM是32位版本，在编译QUIP时会出现integer值的长度冲突。如果你使用的是64位系统应该是可以编译成功的。
</p></div>
</div>
</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">QC-QUIP编译</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1">下载代码</h3>
<div class="outline-text-3" id="text-3-1">



<p>
mod<sub>qcquip</sub><sub>smpl</sub>.f90
</p>


<pre class="example">case(ip_mode)
    print *, "deactivated"
!    stop
    call QC_QUIP_initialise("IP EAM_ErcolAd",ierr)
    end select
</pre>


<pre class="example">!%    This module encapsulates all the interatomic potentials implemented in QUIP
!%
!%    A Potential object represents an interatomic potential, a
!%    tight binding model or an interface to an external code used to
!%    perform calculations. It is initialised from an `args_str`
!%    describing the type of potential, and an XML formatted string
!%    `param_str` giving the parameters.
!%
!%    Types of Potential:
!%
!%      ====================  ==========================================================
!%      `args_str` prefix      Description
!%      ====================  ==========================================================
!%      ``IP``                Interatomic Potential
!%      ``TB``                Tight Binding Model
!%      ``FilePot``           File potential, used to communicate with external program
!%      ``CallbackPot``       Callback potential, computation done by Python function
!%      ``Sum``               Sum of two other potentials
!%      ``ForceMixing``       Combination of forces from two other potentials
!%      ====================  ==========================================================
!%
!%
!%    Types of interatomic potential available:
!%
!%      ======================== ==========================================================
!%      `args_str` prefix        Description
!%      ======================== ==========================================================
!%      ``IP BOP``               Bond order potential for metals
!%      ``IP BornMayer``         Born-Mayer potential for oxides
!%                               (e.g. BKS potential for silica)
!%      ``IP Brenner``           Brenner (1990) potential for carbon
!%      ``IP Brenner_2002``      Brenner (2002) reactive potential for carbon
!%      ``IP Brenner_Screened``  Interface to Pastewka et al. screened Brenner reactive
!%                               potential for carbon
!%      ``IP Coulomb``           Coulomb interaction: support direct summation,
!%                               Ewald and damped shifted force Coulomb potential
!%      ``IP Einstein``          Einstein crystal potential
!%      ``IP EAM_ErcolAd``       Embedded atom potential of Ercolessi and Adams
!%      ``IP FB``                Flikkema and Bromley potential
!%      ``IP FS``                Finnis-Sinclair potential for metals
!%      ``IP FX``                Wrapper around ttm3f water potential of
!%                               Fanourgakis-Xantheas
!%      ``IP GAP``               Gaussian approximation potential
!%      ``IP Glue``              Generic implementation of 'glue' potential
!%      ``IP HFdimer``           Simple interatomic potential for an HF dimer, from
!%                               MP2 calculations
!%      ``IP KIM``               Interface to KIM, the Knowledgebase of Interatomic
!%                               potential Models (www.openkim.org)
!%      ``IP LJ``                Lennard-Jones potential
!%      ``IP Morse``             Morse potential
!%      ``IP PartridgeSchwenke`` Partridge-Schwenke model for a water monomer
!%      ``IP SW``                Stillinger-Weber potential for silicon
!%      ``IP SW_VP``             Combined Stillinger-Weber and Vashista potential
!%                               for Si and :mol:`SiO_2`.
!%      ``IP Si_MEAM``           Silicon modified embedded attom potential
!%      ``IP Sutton_Chen``       Sutton-Chen potential
!%      ``IP TS``                Tangney-Scandolo polarisable potential for oxides
!%      ``IP Tersoff``           Tersoff potential for silicon
!%      ``IP WaterDimer_Gillan`` 2-body potential for water dimer
!%      ======================== ==========================================================
!%
!%    Types of tight binding potential available:
!%
!%      ======================= ==========================================================
!%      `args_str` prefix       Description
!%      ======================= ==========================================================
!%      ``TB Bowler``           Bowler tight binding model
!%      ``TB DFTB``             Density functional tight binding
!%      ``TB GSP``              Goodwin-Skinner-Pettifor tight binding model
!%      ``TB NRL_TB``           Naval Research Laboratory tight binding model
!%      ======================= ==========================================================
!%
!%    Examples of the XML parameters for each of these potential can be
!%    found in the `QUIP_Core/parameters &lt;http://src.tcm.phy.cam.ac.uk/viewvc/jrk33/repo/tags/QUIP_release/QUIP_Core/parameters/&gt;`_
!%    directory of the QUIP svn repository.
!%
</pre>

</div>
</div>
</div>
